<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è³¼ç‰©è»Š</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
    @media (max-width: 640px) {
      /* èª¿æ•´åˆ†é¡æŒ‰éˆ• */
      .category-btn {
        padding: 0.5rem 1rem !important;
        font-size: 0.9rem !important;
      }

      /* èª¿æ•´å•†å“å¡ç‰‡ */
      .product-card {
        padding: 1rem !important;
      }

      /* èª¿æ•´å•†å“åç¨±å­—é«” */
      .product-name {
        font-size: 1.1rem !important;
      }

      /* èª¿æ•´åƒ¹æ ¼å­—é«” */
      .product-price {
        font-size: 1.2rem !important;
      }

      /* èª¿æ•´åº•éƒ¨çµå¸³æ¬„ */
      .checkout-bar {
        padding: 1rem !important;
      }
    }
  </style>
</head>
<body class="bg-gray-900 text-white">

<div id="root"></div>

<!-- å¼•å…¥ React / ReactDOM -->
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- React ç¨‹å¼ -->
<script type="text/babel">
    const {useState, useEffect} = React;

    function ShoppingCart() {
        const [cartItems, setCartItems] = useState([]);
        const [isSyncing, setIsSyncing] = useState(true);

        // åŒæ­¥è³¼ç‰©è»Šæ•¸æ“š
        const syncCartData = async () => {
            try {
                // åŒæ­¥å¾Œç«¯æ•¸æ“š
                const serverResponse = await axios.get('/api/get-cart/');
                const serverCart = serverResponse.data.items || [];

                // åˆä½µæœ¬åœ°å’Œä¼ºæœå™¨æ•¸æ“š
                const mergedCart = serverCart.reduce((acc, serverItem) => {
                    const existingItem = acc.find(i => i.id === serverItem.id);
                    return existingItem
                        ? acc.map(item =>
                            item.id === serverItem.id
                                ? {...item, count: Math.max(item.count, serverItem.count)}
                                : item
                        )
                        : [...acc, serverItem];
                }, JSON.parse(sessionStorage.getItem('cartItems')) || []);

                // éæ¿¾æœ‰æ•ˆé …ç›®ä¸¦æ’åº
                const validCart = mergedCart
                    .filter(item => item.count > 0)
                    .sort((a, b) => a.id - b.id);

                setCartItems(validCart);
                sessionStorage.setItem('cartItems', JSON.stringify(validCart));
                await axios.post('/api/save-cart/', {items: validCart});
            } catch (error) {
                console.error('æ•¸æ“šåŒæ­¥å¤±æ•—:', error);
            } finally {
                setIsSyncing(false);
            }
        };

        useEffect(() => {
            const handleBeforeUnload = async () => {
                // åœ¨é é¢å¸è¼‰å‰å¼·åˆ¶åŒæ­¥
                await axios.post('/api/save-cart/', {items: cartItems});
                sessionStorage.setItem('cartItems', JSON.stringify(cartItems));
            };

            window.addEventListener('beforeunload', handleBeforeUnload);
            syncCartData();

            return () => {
                window.removeEventListener('beforeunload', handleBeforeUnload);
            };
        }, []);

        // æ›´æ–°å•†å“æ•¸é‡
        const updateItemCount = async (itemId, newCount) => {
            if (newCount < 1) return;

            const updatedItems = cartItems
                .map(item => item.id === itemId ? {...item, count: newCount} : item)
                .filter(item => item.count > 0);

            setCartItems(updatedItems);

            // ç«‹å³æ›´æ–°æœ¬åœ°å­˜å„²
            sessionStorage.setItem('cartItems', JSON.stringify(updatedItems));

            // ç•°æ­¥æ›´æ–°å¾Œç«¯
            axios.post('/api/save-cart/', {items: updatedItems});
        };

        // åˆªé™¤å•†å“
        const removeItem = async (itemId) => {
            const updatedItems = cartItems.filter(item => item.id !== itemId);
            setCartItems(updatedItems);

            sessionStorage.setItem('cartItems', JSON.stringify(updatedItems));
            await axios.post('/api/save-cart/', {items: updatedItems});
        };

        // è™•ç†è¿”å›æŒ‰éˆ•
        const handleBackToMenu = async () => {
            // é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹
            setIsSyncing(true);

            // ç¢ºä¿æ•¸æ“šå®Œå…¨åŒæ­¥
            await axios.post('/api/save-cart/', {items: cartItems});
            sessionStorage.setItem('returningFromCart', 'true');

            // å°å‘é é¢
            window.location.href = '/page2_menu/';
        };

        // è¨‚å–®æäº¤è™•ç†
        const handleSubmitOrder = async () => {
            setIsSyncing(true);
            try {
                const orderType = localStorage.getItem('orderType');
                const response = await axios.post('/api/submit-order/', {
                    type: orderType,
                    items: cartItems
                });

                if (response.data.success) {
                    // æ¸…é™¤æ‰€æœ‰è³¼ç‰©è»Šæ•¸æ“š
                    localStorage.removeItem('orderType');
                    sessionStorage.removeItem('cartItems');
                    await axios.post('/api/save-cart/', {items: []});
                    window.location.href = `/page4_order_confirmation/?order_id=${response.data.order_id}`;
                }
            } finally {
                setIsSyncing(false);
            }
        };

        const totalCount = cartItems.reduce((sum, item) => sum + item.count, 0);
        const totalPrice = cartItems.reduce((sum, item) => sum + (item.price * item.count), 0);

        return (
            <div className="p-4 pb-32 relative">
                {/* åŒæ­¥é®ç½© */}
                {isSyncing && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="text-xl font-bold animate-pulse">æ•¸æ“šåŒæ­¥ä¸­...</div>
                    </div>
                )}

                <h1 className="text-3xl font-bold mb-6 border-b border-gray-700 pb-4">è³¼ç‰©è»Šæ˜ç´°</h1>

                {cartItems.length === 0 ? (
                    <div className="text-center py-8 space-y-4">
                        <p className="text-xl">ğŸ›’ æ‚¨çš„è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
                        <button
                            onClick={handleBackToMenu}
                            className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-bold text-lg"
                        >
                            è¿”å›èœå–®é–‹å§‹é¸è³¼
                        </button>
                    </div>
                ) : (
                    <>
                        <div className="space-y-4 mb-8">
                            {cartItems.map(item => (
                                <div key={item.id} className="bg-gray-800 p-4 rounded-lg animate-fade-in">
                                    <div className="flex justify-between items-start mb-3">
                                        <div>
                                            <h3 className="text-xl font-semibold">{item.name}</h3>
                                            <p className="text-gray-400 text-sm">å–®åƒ¹: ${item.price}</p>
                                        </div>
                                        <button
                                            onClick={() => removeItem(item.id)}
                                            className="text-red-400 hover:text-red-300 text-2xl px-2"
                                            title="ç§»é™¤å•†å“"
                                        >
                                            &times;
                                        </button>
                                    </div>

                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center space-x-3">
                                            <button
                                                onClick={() => updateItemCount(item.id, item.count - 1)}
                                                className="bg-gray-700 w-9 h-9 rounded-lg flex items-center justify-center hover:bg-gray-600 transition-colors"
                                            >
                                                <span className="text-xl">-</span>
                                            </button>
                                            <span className="text-xl w-12 text-center">{item.count}</span>
                                            <button
                                                onClick={() => updateItemCount(item.id, item.count + 1)}
                                                className="bg-gray-700 w-9 h-9 rounded-lg flex items-center justify-center hover:bg-gray-600 transition-colors"
                                            >
                                                <span className="text-xl">+</span>
                                            </button>
                                        </div>
                                        <div className="text-xl font-bold">
                                            ${(item.price * item.count).toFixed(2)}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div
                            className="fixed bottom-0 left-0 right-0 bg-gray-800 p-4 shadow-2xl border-t border-gray-700">
                            <div className="flex justify-between items-center mb-3 text-lg">
                                <span>å•†å“æ•¸é‡</span>
                                <span className="font-bold">{totalCount} é …</span>
                            </div>
                            <div className="flex justify-between items-center mb-4 text-xl">
                                <span>ç¸½é‡‘é¡</span>
                                <span className="font-bold text-green-400">${totalPrice.toFixed(2)}</span>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <button
                                    onClick={handleBackToMenu}
                                    className="bg-gray-600 hover:bg-gray-500 text-white py-3 rounded-lg font-bold transition-colors"
                                >
                                    â† ç¹¼çºŒè³¼ç‰©
                                </button>
                                <button
                                    onClick={handleSubmitOrder}
                                    className="bg-green-500 hover:bg-green-400 text-white py-3 rounded-lg font-bold transition-colors"
                                >
                                    ç¢ºèªçµå¸³ â†’
                                </button>
                            </div>
                        </div>
                    </>
                )}
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ShoppingCart/>);
</script>

<style>
    @keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fade-in 0.3s ease-out;
    }
</style>
</body>
</html>